<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReleaseNotesMailMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Maven Jira Plugin</a> &gt; <a href="index.source.html" class="el_package">com.github.lucapino.jira</a> &gt; <span class="el_source">ReleaseNotesMailMojo.java</span></div><h1>ReleaseNotesMailMojo.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013-2107 Luca Tagliani.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.github.lucapino.jira;

import com.github.lucapino.jira.helpers.ProjectJavamailMailSender;
import com.github.lucapino.jira.model.MailSender;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Iterator;
import java.util.List;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import org.apache.maven.model.Developer;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.Execute;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.codehaus.plexus.logging.Logger;
import org.codehaus.plexus.logging.console.ConsoleLogger;
import org.codehaus.plexus.mailsender.MailMessage;
import org.codehaus.plexus.mailsender.MailSenderException;
import org.codehaus.plexus.util.IOUtil;

/**
 * Goal that generates release notes based on a version in a JIRA project.
 *
 * @author Luca Tagliani
 */
@Mojo(name = &quot;mail-release-notes&quot;)
@Execute(goal = &quot;generate-release-notes&quot;)
<span class="nc" id="L45">public class ReleaseNotesMailMojo extends AbstractJiraMojo {</span>

    /**
     * Possible senders.
     */
    @Parameter(property = &quot;project.developers&quot;, required = true, readonly = true)
    private List from;
    /**
     * The id of the developer sending the announcement mail. Only used if the
     * &lt;tt&gt;mailSender&lt;/tt&gt;
     * attribute is not set. In this case, this should match the id of one of
     * the developers in the pom. If a matching developer is not found, then the
     * first developer in the pom will be used.
     */
    @Parameter
    private String fromDeveloperId;
    /**
     * Mail content type to use.
     */
    @Parameter(defaultValue = &quot;text/plain&quot;, required = true)
    private String mailContentType;
    /**
     * Defines the sender of the announcement email. This takes precedence over
     * the list of developers specified in the POM. if the sender is not a
     * member of the development team. Note that since this is a bean type, you
     * cannot specify it from command level with
     * &lt;pre&gt;-D&lt;/pre&gt;. Use
     * &lt;pre&gt;-Dchanges.sender='Your Name &amp;lt;you@domain&gt;'&lt;/pre&gt; instead.
     */
    @Parameter
    private MailSender mailSender;
    /**
     * Defines the sender of the announcement. This takes precedence over both
     * ${changes.mailSender} and the list of developers in the POM.
     * &lt;p/&gt;
     * This parameter parses an email address in standard RFC822 format, e.g.
     * &lt;pre&gt;-Dchanges.sender='Your Name &amp;lt;you@domain&gt;'&lt;/pre&gt;.
     */
    @Parameter
    private String senderString;
    /**
     * The password used to send the email.
     */
    @Parameter
    private String smtpPassword;
    /**
     * Smtp Server.
     */
    @Parameter(required = true)
    private String smtpHost;
    /**
     * Port.
     */
    @Parameter(defaultValue = &quot;25&quot;, required = true)
    private int smtpPort;
    /**
     * If the email should be sent in SSL mode.
     */
    @Parameter(defaultValue = &quot;false&quot;)
    private boolean sslMode;
    /**
     * Subject for the email.
     */
    @Parameter(defaultValue = &quot;[ANNOUNCEMENT] - ${project.name} ${project.version} released&quot;, required = true)
    private String subject;
    /**
     * Template file
     */
    @Parameter(property = &quot;templateFile&quot;)
    File templateFile;
    /**
     * Target file
     */
    @Parameter(property = &quot;targetFile&quot;, defaultValue = &quot;${project.build.directory}/releaseNotes.vm&quot;, required = true)
    File targetFile;
    /**
     * Recipient email address.
     */
    @Parameter
    private List toAddresses;
    /**
     * Recipient cc email address.
     *
     * @parameter
     */
    private List ccAddresses;
    /**
     * Recipient bcc email address.
     */
    @Parameter
    private List bccAddresses;
    /**
     * The username used to send the email.
     */
    @Parameter
    private String smtpUsername;

<span class="nc" id="L142">    private final ProjectJavamailMailSender mailer = new ProjectJavamailMailSender();</span>

    @Override
    public void doExecute() throws Exception {
        // retrieve the announcement crated at the generate-release-notes goal

<span class="nc" id="L148">        ConsoleLogger logger = new ConsoleLogger(Logger.LEVEL_INFO, &quot;base&quot;);</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (getLog().isDebugEnabled()) {</span>
<span class="nc" id="L151">            logger.setThreshold(Logger.LEVEL_DEBUG);</span>
        }

<span class="nc" id="L154">        mailer.enableLogging(logger);</span>

<span class="nc" id="L156">        mailer.setSmtpHost(smtpHost);</span>

<span class="nc" id="L158">        mailer.setSmtpPort(smtpPort);</span>

<span class="nc" id="L160">        mailer.setSslMode(sslMode);</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (smtpUsername != null) {</span>
<span class="nc" id="L163">            mailer.setUsername(smtpUsername);</span>
        }

<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (smtpPassword != null) {</span>
<span class="nc" id="L167">            mailer.setPassword(smtpPassword);</span>
        }

<span class="nc" id="L170">        mailer.initialize();</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (getLog().isDebugEnabled()) {</span>
<span class="nc" id="L173">            getLog().debug(&quot;fromDeveloperId: &quot; + fromDeveloperId);</span>
        }

<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (targetFile.isFile()) {</span>
<span class="nc" id="L177">            getLog().info(&quot;Connecting to Host: &quot; + smtpHost + &quot;:&quot; + smtpPort);</span>

<span class="nc" id="L179">            sendMessage();</span>
        } else {
<span class="nc" id="L181">            throw new MojoExecutionException(&quot;Announcement template &quot; + targetFile + &quot; not found...&quot;);</span>
        }
        // create the mail
        // send the mail
<span class="nc" id="L185">    }</span>

    /**
     * Send the email.
     *
     * @throws MojoExecutionException if the mail could not be sent
     */
    protected void sendMessage()
            throws MojoExecutionException {
<span class="nc" id="L194">        String email = &quot;&quot;;</span>
<span class="nc" id="L195">        final MailSender ms = getActualMailSender();</span>
<span class="nc" id="L196">        final String fromName = ms.getName();</span>
<span class="nc" id="L197">        final String fromAddress = ms.getEmail();</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">        if (fromAddress == null || fromAddress.equals(&quot;&quot;)) {</span>
<span class="nc" id="L199">            throw new MojoExecutionException(&quot;Invalid mail sender: name and email is mandatory (&quot; + ms + &quot;).&quot;);</span>
        }
<span class="nc bnc" id="L201" title="All 6 branches missed.">        if (toAddresses == null &amp;&amp; bccAddresses == null &amp;&amp; ccAddresses == null) {</span>
<span class="nc" id="L202">            throw new MojoExecutionException(&quot;Invalid mail recipients: a recipients (to, cc or bcc) is mandatory (&quot; + ms + &quot;).&quot;);</span>
        }

<span class="nc" id="L205">        getLog().info(&quot;Using this sender for email announcement: &quot; + fromAddress + &quot; &lt; &quot; + fromName + &quot; &gt; &quot;);</span>
        try {
<span class="nc" id="L207">            MailMessage mailMsg = new MailMessage();</span>
<span class="nc" id="L208">            mailMsg.setSubject(subject);</span>
<span class="nc" id="L209">            mailMsg.setContent(IOUtil.toString(new FileInputStream(targetFile), &quot;UTF-8&quot;));</span>
<span class="nc" id="L210">            mailMsg.setContentType(this.mailContentType);</span>
<span class="nc" id="L211">            mailMsg.setHeader(&quot;Content-Transfer-Encoding&quot;, &quot;quoted-printable&quot;);</span>
<span class="nc" id="L212">            mailMsg.setFrom(fromAddress, fromName);</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (toAddresses != null) {</span>
<span class="nc" id="L215">                final Iterator it = toAddresses.iterator();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                while (it.hasNext()) {</span>
<span class="nc" id="L217">                    email = it.next().toString();</span>
<span class="nc" id="L218">                    getLog().info(&quot;Sending mail to &quot; + email + &quot;...&quot;);</span>
<span class="nc" id="L219">                    mailMsg.addTo(email, &quot;&quot;);</span>
                }
            }
<span class="nc bnc" id="L222" title="All 2 branches missed.">            if (ccAddresses != null) {</span>
<span class="nc" id="L223">                final Iterator it2 = ccAddresses.iterator();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                while (it2.hasNext()) {</span>
<span class="nc" id="L225">                    email = it2.next().toString();</span>
<span class="nc" id="L226">                    getLog().info(&quot;Sending cc mail to &quot; + email + &quot;...&quot;);</span>
<span class="nc" id="L227">                    mailMsg.addCc(email, &quot;&quot;);</span>
                }
            }

<span class="nc bnc" id="L231" title="All 2 branches missed.">            if (bccAddresses != null) {</span>
<span class="nc" id="L232">                final Iterator it3 = bccAddresses.iterator();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                while (it3.hasNext()) {</span>
<span class="nc" id="L234">                    email = it3.next().toString();</span>
<span class="nc" id="L235">                    getLog().info(&quot;Sending bcc mail to &quot; + email + &quot;...&quot;);</span>
<span class="nc" id="L236">                    mailMsg.addBcc(email, &quot;&quot;);</span>
                }
            }

<span class="nc" id="L240">            mailer.send(mailMsg);</span>
<span class="nc" id="L241">            getLog().info(&quot;Sent...&quot;);</span>
<span class="nc" id="L242">        } catch (IOException ioe) {</span>
<span class="nc" id="L243">            throw new MojoExecutionException(&quot;Failed to send email.&quot;, ioe);</span>
<span class="nc" id="L244">        } catch (MailSenderException e) {</span>
<span class="nc" id="L245">            throw new MojoExecutionException(&quot;Failed to send email &lt; &quot; + email + &quot; &gt;&quot;, e);</span>
<span class="nc" id="L246">        }</span>
<span class="nc" id="L247">    }</span>

    /**
     * Returns the identify of the mail sender according to the plugin's
     * configuration:
     * &lt;ul&gt;
     * &lt;li&gt;if the &lt;tt&gt;mailSender&lt;/tt&gt; parameter is set, it is returned&lt;/li&gt;
     * &lt;li&gt;if no &lt;tt&gt;fromDeveloperId&lt;/tt&gt; is set, the first developer in the
     * list is returned&lt;/li&gt;
     * &lt;li&gt;if a &lt;tt&gt;fromDeveloperId&lt;/tt&gt; is set, the developer with that id is
     * returned&lt;/li&gt;
     * &lt;li&gt;if the developers list is empty or if the specified id does not
     * exist, an exception is thrown&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @return the mail sender to use
     * @throws MojoExecutionException if the mail sender could not be retrieved
     */
    protected MailSender getActualMailSender()
            throws MojoExecutionException {
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (senderString != null) {</span>
            try {
<span class="nc" id="L269">                InternetAddress ia = new InternetAddress(senderString, true);</span>
<span class="nc" id="L270">                return new MailSender(ia.getPersonal(), ia.getAddress());</span>
<span class="nc" id="L271">            } catch (AddressException e) {</span>
<span class="nc" id="L272">                throw new MojoExecutionException(&quot;Invalid value for change.sender: &quot;, e);</span>
            }
        }
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if (mailSender != null &amp;&amp; mailSender.getEmail() != null) {</span>
<span class="nc" id="L276">            return mailSender;</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">        } else if (from == null || from.isEmpty()) {</span>
<span class="nc" id="L278">            throw new MojoExecutionException(</span>
                    &quot;The &lt;developers&gt; section in your pom should not be empty. Add a &lt;developer&gt; entry or set the &quot;
                    + &quot;mailSender parameter.&quot;);
<span class="nc bnc" id="L281" title="All 2 branches missed.">        } else if (fromDeveloperId == null) {</span>
<span class="nc" id="L282">            final Developer dev = (Developer) from.get(0);</span>
<span class="nc" id="L283">            return new MailSender(dev.getName(), dev.getEmail());</span>
        } else {
<span class="nc" id="L285">            final Iterator it = from.iterator();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            while (it.hasNext()) {</span>
<span class="nc" id="L287">                Developer developer = (Developer) it.next();</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">                if (fromDeveloperId.equals(developer.getId())) {</span>
<span class="nc" id="L290">                    return new MailSender(developer.getName(), developer.getEmail());</span>
                }
<span class="nc" id="L292">            }</span>
<span class="nc" id="L293">            throw new MojoExecutionException(</span>
                    &quot;Missing developer with id '&quot; + fromDeveloperId + &quot;' in the &lt;developers&gt; section in your pom.&quot;);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>